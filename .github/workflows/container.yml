name: container build and push

on:
  push:
    branches: [ "*" ]
    tags: [ '*.*.*' ]
  pull_request:
    branches: [ "*" ]

# env:
#   REGISTRY: ghcr.io
#   EULIX_REGISTRY: hub.eulix.xyz
#   HUAWEICLOUD_REGISTRY_SH: swr.cn-east-3.myhuaweicloud.com
#   HUAWEICLOUD_REGISTRY_BJ: swr.cn-north-4.myhuaweicloud.com
#   HUAWEICLOUD_REGISTRY_GZ: swr.cn-south-1.myhuaweicloud.com
#   HUAWEICLOUD_REGISTRY_HK: swr.ap-southeast-1.myhuaweicloud.com
#   HUAWEICLOUD_REGISTRY_SG: swr.ap-southeast-3.myhuaweicloud.com
#   HUAWEICLOUD_REGISTRY_AF: swr.af-south-1.myhuaweicloud.com
#   HUAWEICLOUD_REGISTRY_LA: swr.la-north-2.myhuaweicloud.com
#   IMAGE_NAME: ${{ github.repository }}

jobs:

  build:
    runs-on: macos-latest
    permissions:
      contents: read
      packages: write
      id-token: write
      

    steps:
    - uses: actions/checkout@v3
      # with:
      #   submodules: recursive
  

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: 'stable'

    - name: package-gt
      run: |-
        xcodebuild -version
        brew install make  llvm@16 gcc
        export PATH="/usr/local/opt/llvm@16/bin:$PATH"
        export LDFLAGS="-L/usr/local/opt/llvm@16/lib"
        export CPPFLAGS="-I/usr/local/opt/llvm@16/include"
        rustup target add x86_64-apple-darwin aarch64-apple-darwin
        make

    - name: Archive GT artifacts
      uses: actions/upload-artifact@v3
      with:
        name: gt-mac
        path: |
          release/*
