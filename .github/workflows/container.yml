name: container build and push

on:
  push:
    branches: [ "*" ]
    tags: [ '*.*.*' ]
  pull_request:
    branches: [ "*" ]

# env:
#   REGISTRY: ghcr.io
#   EULIX_REGISTRY: hub.eulix.xyz
#   HUAWEICLOUD_REGISTRY_SH: swr.cn-east-3.myhuaweicloud.com
#   HUAWEICLOUD_REGISTRY_BJ: swr.cn-north-4.myhuaweicloud.com
#   HUAWEICLOUD_REGISTRY_GZ: swr.cn-south-1.myhuaweicloud.com
#   HUAWEICLOUD_REGISTRY_HK: swr.ap-southeast-1.myhuaweicloud.com
#   HUAWEICLOUD_REGISTRY_SG: swr.ap-southeast-3.myhuaweicloud.com
#   HUAWEICLOUD_REGISTRY_AF: swr.af-south-1.myhuaweicloud.com
#   HUAWEICLOUD_REGISTRY_LA: swr.la-north-2.myhuaweicloud.com
#   IMAGE_NAME: ${{ github.repository }}

jobs:

  build-x8664-macos:
    runs-on: macos-13
    permissions:
      contents: read
      packages: write
      id-token: write
      

    steps:
    - uses: actions/checkout@v3
    #   with:
    #     submodules: recursive
  

    # - name: Set up Go
    #   uses: actions/setup-go@v4
    #   with:
    #     go-version: 'stable'

    - name: package-gt
      run: |-
        brew install make  llvm@16 binutils  ninja
        pip3 install --upgrade setuptools
        curl -LOJ https://chrome-infra-packages.appspot.com/dl/gn/gn/mac-amd64/+/latest
        unzip gn-mac-amd64.zip
        chmod +x gn && mv gn /usr/local/opt/llvm@16/bin/
        ln -s /usr/local/opt/llvm@16 /opt/homebrew/opt/llvm
        ln -s /usr/local/opt/llvm@16 /usr/local/opt/llvm
        ln -s /usr/local/opt/llvm@16/bin/llvm-objcopy /usr/local/opt/llvm@16/bin/llvm-objcopy-mp-15
        echo 'export PATH="/usr/local/opt/llvm@16/bin:$PATH"' >> ~/.bash_profile
        export PATH="/usr/local/opt/make/libexec/gnubin:$PATH"
        echo 'export PATH="/usr/local/opt/binutils/bin:$PATH"' >> ~/.bash_profile
        source ~/.bash_profile
        mv /usr/local/opt/llvm/bin/llvm-libtool-darwin /usr/local/opt/llvm/bin/libtool
        rustup target add x86_64-apple-darwin aarch64-apple-darwin
        # cd ./libcs && TARGET=x86_64-apple-darwin GOOS=darwin GOARCH=amd64 arch -arch x86_64 make release_lib
        # cargo build --target x86_64-apple-darwin -r
        # mkdir -p release
        # cp target/x86_64-apple-darwin/release/gt release/gt-darwin-x86_64

    - name: Archive GT artifacts
      uses: actions/upload-artifact@v3
      with:
        name: gt-x8664-macos
        path: |
          release/*

  # build-arm64-macos:
  #   runs-on: macos-14
  #   permissions:
  #     contents: read
  #     packages: write
  #     id-token: write
      

  #   steps:
  #   - uses: actions/checkout@v3
  #     with:
  #       submodules: recursive
  

  #   - name: Set up Go
  #     uses: actions/setup-go@v4
  #     with:
  #       go-version: 'stable'

  #   - name: package-gt
  #     run: |-
  #       brew install make  llvm@16 binutils  ninja
  #       curl -LOJ https://chrome-infra-packages.appspot.com/dl/gn/gn/mac-amd64/+/latest
  #       unzip gn-mac-amd64.zip
  #       chmod +x gn && mv gn /opt/homebrew/opt/llvm@16/bin/
  #       ln -s /opt/homebrew/opt/llvm@16 /opt/homebrew/opt/llvm
  #       ln -s /opt/homebrew/opt/llvm@16/bin/llvm-objcopy /opt/homebrew/opt/llvm@16/bin/llvm-objcopy-mp-15
  #       echo 'export PATH="/opt/homebrew/opt/llvm/bin:$PATH"' >> ~/.bash_profile
  #       export PATH="/opt/homebrew/opt/make/libexec/gnubin:$PATH"
  #       echo 'export PATH="/opt/homebrew/opt/binutils/bin:$PATH"' >> ~/.bash_profile
  #       source ~/.bash_profile
  #       mv /opt/homebrew/opt/llvm/bin/llvm-libtool-darwin /opt/homebrew/opt/llvm/bin/libtool
  #       rustup target add x86_64-apple-darwin aarch64-apple-darwin
  #       cd ./libcs &&  TARGET=aarch64-apple-darwin GOOS=darwin GOARCH=arm64 arch -arch arm64 make release_lib
  #       cargo build --target aarch64-apple-darwin -r
  #       mkdir -p release
  #       cp target/aarch64-apple-darwin/release/gt release/gt-darwin-aarch64

  #   - name: Archive GT artifacts
  #     uses: actions/upload-artifact@v3
  #     with:
  #       name: gt-arm64-macos
  #       path: |
  #         release/*
